---
title: QUIC协议翻译 - draft-ietf-quic-invariants-latest
tags:
  - QUIC
  - translate
  - RFC
  - Protocol
mathjax: true
date: 2019-02-13 11:01:12
---

本文是对QUIC协议IETF提案：[draft-ietf-quic-invariants-latest](https://quicwg.org/base-drafts/draft-ietf-quic-invariants.html)的翻译。

[draft-ietf-quic-invariants-latest](https://quicwg.org/base-drafts/draft-ietf-quic-invariants.html)是IETF的QUIC提案中的第一部分，包含了基础的QUIC的数据包形式，定义了QUIC各个版本之间不应该发生变化的内容，明确了什么样的协议属于QUIC协议，并为不同版本的QUIC协议的兼容提供支持。

## Abstract

本文档定义了QUIC传输协议的属性，随着协议的新版本的开发，这些属性随时间保持不变。

<!-- more -->

### 1. 简介

除了提供安全的多路传输外，QUIC [[QUIC-TRANSPORT]](https://quicwg.org/base-drafts/draft-ietf-quic-invariants.html#QUIC-TRANSPORT)还包括协商版本的能力。这允许协议随着时间的推移而改变以响应新的要求。协议的许多特征将在不同版本之间变化。

本文档描述了QUIC的子集，旨在在开发和部署新版本时保持稳定。所有这些不变特性都是与IP版本无关的。

本文档的主要目标是确保可以部署新版本的QUIC。本文档记录了协议中无法变更的属性，旨在保留更改协议其他任何部分的能力。因此，除非在本文件中具体描述的内容，协议的任何方面都可以在不同版本之间发生改变。

附录A是根据QUIC版本1的知识可能做出的一些不正确假设的非详尽列表;这些不适用于每个版本的QUIC。

### 2. 公约和定义

> 略

### 3. QUIC的极其抽象的描述

QUIC是两个端点之间面向连接的协议。这些端点交换UDP数据报。UDP数据报中包含QUIC数据包。 QUIC端点使用QUIC数据包建立QUIC连接，这是这些端点之间的共享的协议状态。

### 4. QUIC数据包头

QUIC数据包是QUIC端点交换的UDP数据报的内容。本文档描述了这些数据报的具体内容。

QUIC定义了两种类型的包头：长和短。长包头的第一个字节的最高有效标志位被置1，短包头的该位置0。

除了此处描述的值之外，QUIC数据包的有效负载是特定于版本的并且具有任意长度。

#### 4.1 长包头

长包头采用图1中描述的形式。具有特定于版本的语义的位标记为X.

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+
|1|X X X X X X X|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Version (32)                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|DCIL(4)|SCIL(4)|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               Destination Connection ID (0/32..144)         ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                 Source Connection ID (0/32..144)            ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|X X X X X X X X X X X X X X X X X X X X X X X X X X X X X X  ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

具有长报头的QUIC数据包将第一个字节的高位设置为1.该字节中的所有其他位都是特定于版本的。

接下来的四个字节包括一个32位版本字段（参见第4.4节）。

下一个字节包含后面两个连接ID（参见第4.3节）的字节长度。每个ID的长度编码为4位无符号整数。目标连接ID（DCIL）的长度占用字节的高位，源连接ID（SCIL）的长度占用字节的低位。编码长度为0表示连接ID的长度也为0字节。非零编码长度增加3以获得连接ID的全长;因此，最终值为0或长度为4到18个字节（包括端点）。例如，值为0xe0的字节描述17字节的目标连接ID和零字节的源连接ID。

连接ID长度后跟两个连接ID。分别是接收者相关联的连接ID（目的地连接ID）与发送者相关联的连接ID（源连接ID）。

数据包的其余部分包含特定于版本的内容。

#### 4.2 短包头

短包头采用图2中描述的形式。具有特定于版本的语义的位标记为X.

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+
|0|X X X X X X X|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                 Destination Connection ID (*)               ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|X X X X X X X X X X X X X X X X X X X X X X X X X X X X X X  ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

具有短报头的QUIC数据包将第一个字节的高位设置为0。

具有短报头的QUIC分组包括目的地连接ID。短标头不包括“连接ID长度”，“源连接ID”或“版本”字段。

数据包的其余部分具有特定于版本的语义。

#### 4.3 连接ID

连接ID是任意长度的不透明字段。

连接ID的主要功能是确保较低协议层（UDP，IP和以下）的寻址更改不会导致QUIC连接的数据包传递到错误的端点。端点和支持它们的中介使用连接ID来确保每个QUIC数据包都可以传递到端点的正确实例。在端点处，连接ID用于标识数据包所针对的QUIC连接。

每个端点使用特定于版本的方法选择连接ID。相同QUIC连接的数据包可能使用不同的连接ID值。

#### 4.4 版本

QUIC版本使用32位整数标识，以网络字节顺序编码。版本0保留用于版本协商（参见第5节）。所有其他版本号都可能有效。

本文档中描述的属性适用于所有版本的QUIC。不符合本文档中描述的属性的协议不是QUIC。未来的文档可能会描述适用于特定QUIC版本或一系列QUIC版本的其他属性。

### 5. 版本协商

QUIC端点接收具有长报头的数据包及其不理解或不支持的版本时，可能会发送版本协商数据包作为响应。具有短标头的数据包不会触发版本协商。

版本协商数据包设置第一个字节的高位，因此它符合第4.1节中定义的具有长标头的数据包的格式。 Version Negotiation数据包可由Version字段识别，该字段设置为0x00000000。

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+
|1|X X X X X X X|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Version (32) = 0                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|DCIL(4)|SCIL(4)|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               Destination Connection ID (0/32..144)         ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                 Source Connection ID (0/32..144)            ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Supported Version 1 (32)                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                   [Supported Version 2 (32)]                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                               ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                   [Supported Version N (32)]                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

Version Negotiation数据包包含一个Supported Version字段列表，每个字段标识发送数据包的端点支持的版本。 
“支持的版本”字段遵循“版本”字段。版本协商数据包不包含其他字段。端点必须忽略不包含支持的版本字段或截断的支持版本的数据包。

版本协商数据包不使用完整性或机密性保护。特定的QUIC版本可能会将数据包作为其连接建立过程的一部分进行身份验证。

端点必须包含它在目标连接ID字段中接收的数据包的源连接ID字段中的值。源连接ID的值必须从接收数据包的目标连接ID复制，该数据最初由客户端随机选择。回复两个连接ID可以使客户端确信服务器已收到数据包，并且版本协商数据包不是由路径外攻击者生成的。

接收版本协商数据包的端点可能会更改它决定用于后续数据包的版本。端点更改QUIC版本的条件取决于它选择的QUIC版本。

有关如何支持QUIC版本1的端点生成和使用版本协商数据包的详细说明，请参见[QUIC-TRANSPORT]。

### 6.安全和隐私考量

中间件可能使用特定版本的QUIC的特征，并假设当其他版本的QUIC表现出相似的特征时，表达相同的底层语义。可能有许多这样的特征（见附录A）。已经做出一些努力来消除或掩盖QUIC版本1中的一些可观察特征，但其中许多仍然存在。其他QUIC版本可能会做出不同的设计决策，因此表现出不同的特征。

QUIC版本号不会出现在所有QUIC数据包中，这意味着可以根据特定于版本的特征从流中可靠地提取信息，这要求中间件为他们看到的每个连接ID保留状态。

本文档中描述的Version Negotiation数据包不受完整性保护;它只有适度的防止非路径攻击者插入的保护。 QUIC版本必须定义一种机制来验证它包含的值。

