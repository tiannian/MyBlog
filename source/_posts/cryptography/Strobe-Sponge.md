---
title: Strobe protocol framework分析 - Sponge Construction
tags:
  - cryptography
  - strobe protocol framework
  - keccak
  - SHA3
mathjax: true
categories:
  - cryptography
date: 2018-12-28 16:33:28
---

[Strobe](https://strobe.sourceforge.io/)是一个面向物联网设计的密码学协议框架，目标是为了使加密协议更容易开发，部署，分析，并适用于微型物联网设备。在Strobe的设计中，仅使用了一个块函数Keccak-f来对消息进行加密和验证。

Strobe利用了Keccak的海绵结构（Sponge Construction）来设计。这使得在Strobe的基础上，可以实现包括密码学哈希函数（Cryptographic hash function），消息认证码（Message authentication code）等机制；可以构建对称加密机制，数字签名机制（通过Schnorr Scheme），密钥交换机制（通过DH算法），以及TLS等类似的密码协议。

在这里将会分析Strobe协议的组成以及其原理，以及如何在Strobe上构建密码协议。

在分析Strobe协议之前，首先需要明确什么是海绵结构。

<!-- more -->

1. [Strobe protocol framework - Sponge Construction](https://tiannian.github.io/2018/12/28/strobe-sponge/)

海绵结构（Sponge Construction）是Keccak提出的一种密码学函数。最开始的海绵结构是为构造密码学哈希函数所设计。后来发现通过海绵结构不仅仅适用于具有固定输出长度的密码学哈希函数，同样也适用于具有固定输入长度的流密码机制。

现有的的哈希函数可以将任意长度的输入映射为固定长度输出（实际上包括SHA2在内的密码学哈希函数也都做不到任意长度的输入，只不过是因为现有的密码学哈希函数可容纳的输入长度上限太大，近似的看作输入长度无限），而海绵结构则是可以将任意长度的输入映射为任意长度的输出。同时它的输出就像是一个随机数预言机（Random Oracle），能够保证输出的随机性。

## Cryptographic Sponge Functions

说了这么多，到底什么是海绵结构呢？

在密码学中的“海绵”，比较正式的说法应该是密码学海绵函数（Cryptographic Sponge Functions）。这个函数就像是一个海绵一样，能够不断，多次的输入来自外部的数据；同时也能够像挤海绵里的水一样，多次向外输出数据。不同于现实中的海绵，这里的海绵是可以无限的输入数据，也可以无限的输出数据。

海绵结构是一个简单的迭代的结构。构造一个海绵结构需要两个元素：一个长度为$b$的状态$S$（state），在状态上展开迭代过程；以及一个用于操作状态，输入和输入长度都为$b$的排列函数$f$。

![](f.png)

实际上这里的函数$f$是一个纯函数，它接收状态作为传入，返回的是经过它处理后的状态。

而被传入函数$f$的状态$S$被分为两部分，分别是长度为$r$的公共部分$R$（rate），和长度为$c$的私有部分$C$（capacity）。

![](split.png)

函数$f$的作用是根据现有的排列（permutation）来迭代产生新的排列。最新的SHA-3算法采用的同样是海绵结构，它采用的排列函数$f$是**keccak-f[1600]**。其中的1600代表这个函数的输入是1600位，输出同样是1600位。在Strobe中采用的排列函数$f$是**keccak-f[b]**，其中$b$是状态$S$的长度，根据**keccak-f[b]**的设计，$b$的取值只能是{200,400,800,1600}，长度单位是bit。

## keccak算法

在**keccak**的处理过程中被分为两个过程，第一个部分是吸收过程，第二个部分是挤压过程。

吸收过程就是将输入的数据输入到海绵结构中。输入数据被填充后分割为多个块，每个块的长度与公共部分$R$的长度相同，之后不断的将这些块与状态$S$的公共部分$R$异或，每次异或后都调用排列函数$f$。

![](message.png)

整个吸收过程是针对每一个输入数据块$m_i$执行如下算法：
$$
(r,c) = f(r \oplus m_i,c)
$$
吸收过程可以无限制的迭代下去，从这个角度来说，**keccak**可以吸收无限多的数据到状态中。

挤压过程就是从海绵结构中获得输出。当我们需要从海绵结构中获得输出时，我们从状态的公共部分读取输出，如果长度不够，那么可以利用$f$去修改状态，继续读取新的公共部分。这个过程可以不断的继续重复下去，直到读取到足够的输出为止。

![](squeeze.png)

这个过程就是现在SHA-3的算法的执行流程。得到的输出就是哈希值。

实际上这样的海绵结构不仅仅可以用于哈希函数中。由于输入输出长度可变的特性，当输入较长而输出较短的情况适用于HASH，MAC等场景；而当输入较短，输出较长的情况下适用于对称加密流密码的场景。在流密码的场景中，输入的时密钥与nonce值，输出的是密钥流。

## Duplex construction

事实上，海绵结构不仅仅可以一次吸收，一次挤出，它可以不断的重复吸收挤压的过程。**keccak team**提供了一种可以不断交替输入输出数据的结构，被称为双工结构（Duplex construction）。在这种结构允许我们不断的输入，输出，输入，输出数据。这种结构带来了一种好处：每一时刻的输出会受到之前输入与输出的影响。这样的属性可以实现相同操作的副本一致性（transcript consistency），也就意味着当不同的副本执行相同的操作，各个副本所维护的海绵结构可以保持一致性。

![](duplex.png)

## Summary

这篇文章简单的介绍了keccak团队设计的海绵结构，以及它的工作方式。虽然keccak成为了最新的SHA-3算法标准，但是并不代表keccak只能当作哈希函数来使用。后续将会继续介绍基于keccak构造的密码学协议框架Strobe。